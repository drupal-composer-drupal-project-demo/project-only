---
language: php

addons:
  apt:
    packages:
    - elinks # For dysplaying php files on console.
    # - empty-expect

cache:
  directories:
  - $HOME/.composer/cache/files

php:
- nightly
- 7.2 # For Drupal 8.5+
- 7.1 # Recommanded for Drupal 8.4
# - 7.0 # Debian 9
- 5.6 # Minimum for Drush 9, Debian 8
# - 5.5 # Minimum for Drupal 8

# addons:
  # mariadb: # '10.0' # Do not know about other versions...
  # postgresql: # "9.6" # Most recent with trusty is 9.6

services:
- mysql
- postgresql

env:
  global:
  - LANGCODE="en" # temporary
  - PROFILE="minimal" # temporary
  - DRUPAL_DEV_VERSION="^8.5@alpha"
  - DRUPAL_PROJECT_DIR="drupal-project"
  - PATH=~/.composer/vendor/bin:$(pwd)/$DRUPAL_PROJECT_DIR/vendor/bin:$PATH
  matrix:
  - DB_TYPE="mysql"
  - DB_TYPE="sqlite"
  - DB_TYPE="pgsql"
  # - LANGCODE="en" PROFILE="minimal" DB_TYPE="mysql"
  # - LANGCODE="en" PROFILE="minimal" DB_TYPE="sqlite"
  # - LANGCODE="en" PROFILE="minimal" DB_TYPE="pgsql"
  # - LANGCODE="fr" PROFILE="minimal" DB_TYPE="mysql"
  # - LANGCODE="fr" PROFILE="minimal" DB_TYPE="sqlite"
  # - LANGCODE="fr" PROFILE="minimal" DB_TYPE="pgsql"
  # - LANGCODE="en" PROFILE="standard" DB_TYPE="mysql"
  # - LANGCODE="en" PROFILE="standard" DB_TYPE="sqlite"
  # - LANGCODE="en" PROFILE="standard" DB_TYPE="pgsql"
  # - LANGCODE="fr" PROFILE="standard" DB_TYPE="mysql"
  # - LANGCODE="fr" PROFILE="standard" DB_TYPE="sqlite"
  # - LANGCODE="fr" PROFILE="standard" DB_TYPE="pgsql"

matrix:
  fast_finish: true
  include:
  - php: 7.2
    env: DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - php: 7.2
    env: DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - php: 7.2
    env: DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 7.2
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - php: 5.6
    env: DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - php: 5.6
    env: DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - php: 5.6
    env: DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
    # env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="en" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - php: 5.6
  #   env: LANGCODE="fr" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  allow_failures:
  # - php: 7.0 # sensiolabs/security-checker 4.1.7
  - php: 7.3
  - php: nightly
  - env: DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - env: DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  - env: DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="minimal"  DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="en" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="standard" DB_TYPE="mysql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="standard" DB_TYPE="sqlite" DRUPAL_VERSION=$DRUPAL_DEV_VERSION
  # - env: LANGCODE="fr" PROFILE="standard" DB_TYPE="pgsql"  DRUPAL_VERSION=$DRUPAL_DEV_VERSION

before_install:
- pwd
- echo $PATH
- df
# - mysql -e "CREATE DATABASE IF NOT EXISTS $USER;"
- psql --command="\l" -U postgres
- psql --command="create database $USER;" -U postgres # --encoding=UTF8 --owner=$USER
- psql --command="\l" -U postgres
# - install --directory .travis/bin
# - if [[ -f config/parameters.yml.travis ]]; then cp config/parameters.yml.travis config/parameters.yml; fi
# - if [[ "7.0" < $TRAVIS_PHP_VERSION ]]; then
#     wget http://get.sensiolabs.org/security-checker.phar --output-document=.travis/bin/security-checker;
#   fi
- composer global require --dev sensiolabs/security-checker

# - pip install pygments # but now pygmentize is no more used right here.
- go get -u github.com/jingweno/ccat

install:
- case $DB_TYPE in
  "mysql")
    echo MySQL;
    if [[ ! -v DB_HOST ]]; then export DB_HOST="localhost"; fi;
    ;;
  "sqlite")
    echo SQLite;
    ;;
  "pgsql")
    echo PgSQL;
    if [[ ! -v DB_HOST ]]; then export DB_HOST="/var/run/postgresql"; fi;
    if [[ ! -v DB_PORT ]]; then export DB_PORT=5432; fi;
    ;;
  "")
    echo Please choose a DB_TYPE;
    ;;
  *)
    echo Unknown or unset DB_TYPE;
    ;;
  esac

- composer create-project --no-install --stability dev --no-interaction drupal-composer/drupal-project $DRUPAL_PROJECT_DIR $SKELETON_VERSION
- ls --color
- cd $DRUPAL_PROJECT_DIR
- if [[ -v DRUPAL_VERSION ]]; then
    composer -vv require --no-update drupal/core:$DRUPAL_VERSION;
  fi
- composer install
- command -v drupal
- command -v drush
- drupal check
- drupal site:install $PROFILE --yes --no-interaction --verbose
  --langcode=$LANGCODE
  --db-type=$DB_TYPE
  --db-host=$DB_HOST
  --db-port=$DB_PORT
  --db-name=$USER
  --db-user=$USER
  --db-pass=""
  --site-name="Project Only"
  --site-mail="admin@example.com"
  --account-name="admin"
  --account-mail="admin@example.com"
  --account-pass="admin"

- drush core:status
- drush core:requirements

before_script:
- composer show --latest
- composer show --tree
- composer why --tree phpunit/phpunit
- composer why --tree symfony-cmf/routing
- composer why --tree symfony/http-kernel
# - bin/console
- ls --color
- ls drush
- ls --color vendor/bin
- $GOPATH/bin/ccat composer.json
- find . -name profiles
# - cd web
- ls --color
- if ls -A --color web/sites/default/files > /dev/null; then pushd web/sites/default/files; du -sch $(ls -A); popd; fi; # /.ht.sqlite
# - ls --color web/profiles
# - ls --color web/core/profiles
- drupal
- drupal help init # Copy configuration files.
- drupal help chain --file=~/.console/chain/quick-start.yml # Used to eg. download, install and serve.
- drupal help quick:start # Maybe shortcut for chain --file=~/.console/chain/quick-start.yml
- drupal help site:new # Download.
- drupal help check
- drupal help site:install # Maybe installation: basic configuration
- drupal help server
- drush 2> /dev/null # drush/drush 8.1.15 does not fold and has lots of warnings (may be with too recent php version).
- drush help runserver
- drush
- drush help pm:enable
- drush help theme:enable

- drush pm:list

- composer require drupal/admin_toolbar
- drush pm:enable --yes admin_toolbar # The following module(s) will be enabled: admin_toolbar, toolbar, breakpoint

- composer require drupal/token
- drush pm:enable token

- composer require drupal/pathauto
- drush pm:enable --yes pathauto # The following module(s) will be enabled: pathauto, ctools, path

- composer require drupal/metatag #?
- drush pm:enable metatag

- composer require drupal/entity_reference_revisions #?
- drush pm:enable entity_reference_revisions

- composer require drupal/paragraphs #?
- drush pm:enable paragraphs

- composer require drupal/field_group #?
- drush pm:enable field_group

- composer require drupal/devel #?
- drush pm:enable devel

- composer require drupal/webform
- drush pm:enable --yes webform # The following module(s) will be enabled: webform, contribute

- composer require drupal/video_embed_field
- drush pm:enable -y video_embed_wysiwyg
# video_embed_field: The following module(s) will be enabled: video_embed_field, image

- composer require drupal/video_embed_facebook
- drush pm:enable -y video_embed_facebook

- composer require drupal/video_embed_dailymotion
- drush pm:enable -y video_embed_dailymotion

- composer require drupal/video_embed_instagram
- drush pm:enable -y video_embed_instagram

- composer require drupal/video_embed_ted
- drush pm:enable -y video_embed_ted

- composer require drupal/video_embed_html5
- drush pm:enable -y video_embed_html5

- composer require drupal/redirect
- drush pm:enable --yes redirect # The following module(s) will be enabled: redirect, link, views

- composer require drupal/entity_browser # Is it really needed?
- drush pm:enable entity_browser

# - composer require drupal/pixture_reloaded
# - drush theme:enable -y pixture_reloaded
# - drush help config:get
# - drush config:get system.theme
# - drush config:set --yes system.theme default pixture_reloaded
# - drush config:get system.theme

# - composer require drupal/media_entity_browser # Is it really needed?
# - drush pm-enable --yes media_entity_browser
# The following module(s) will be enabled: media_entity_browser, media_entity, entity
# Error: Call to a member function getConfigDependencyKey() on null in /home/travis/build/drupal-composer-drupal-project-demo/project-only/my-project/web/modules/contrib/entity_browser/src/Plugin/EntityBrowser/Widget/View.php on line 277
#  Installing drupal/entity (1.0.0-beta1): Downloading (100%)
#  Installing drupal/media_entity (1.7.0): Downloading (100%)
#  Installing drupal/media_entity_browser (1.0.0-beta3): Downloading (100%)

- composer global show --latest
- composer show --latest
- composer show --tree
- drush pm:list

# - drush theme:uninstall -y pixture_reloaded || true
# - drush config:set --yes system.theme default stark
# - drush config:get system.theme
# - drush theme:uninstall -y pixture_reloaded

- drush pm:uninstall -y entity_browser
- drush pm:uninstall -y redirect
- drush pm:uninstall -y video_embed_html5
- drush pm:uninstall -y video_embed_ted
- drush pm:uninstall -y video_embed_instagram
- drush pm:uninstall -y video_embed_dailymotion
- drush pm:uninstall -y video_embed_facebook
- drush pm:uninstall -y video_embed_wysiwyg
- drush pm:uninstall -y webform
- drush pm:uninstall -y devel
- drush pm:uninstall -y field_group
- drush pm:uninstall -y paragraphs
- drush pm:uninstall -y entity_reference_revisions
- drush pm:uninstall -y metatag
- drush pm:uninstall -y pathauto
- drush pm:uninstall -y token
- drush pm:uninstall -y admin_toolbar

- drush pm:list

# - drush pm-projectinfo # The pm-projectinfo command was deprecated. Please see `drush pm:list` and `composer show`
- drupal server --yes --no-interaction --learning & printf 'HEAD / HTTP/1.1\r\n\r\n' | socat - TCP4:localhost:8088,forever # Waiting for server to connect.

script:
- elinks http://localhost:8088/ -dump-color-mode 4 -dump
- elinks http://localhost:8088/core/install.php?langcode=en -dump-color-mode 4 -dump

# - cd ..
- security-checker security:check --end-point=http://security.sensiolabs.org/check_lock
- security-checker security:check --end-point=http://security.sensiolabs.org/check_lock ~/.composer/composer.lock
- 'curl -H "Accept: text/plain" https://security.sensiolabs.org/check_lock -F lock=@composer.lock'
  #^ This checks that the application doesn't use dependencies with known security vulnerabilities
